name: JWT Key Rotation

on:
  # Ejecutar cada 3 meses (el 1 de enero, abril, julio, octubre a las 2 AM UTC)
  schedule:
    - cron: '0 2 1 1,4,7,10 *'  # 2 AM UTC on Jan 1, Apr 1, Jul 1, Oct 1
  
  # TambiÃ©n permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      force:
        description: 'Force rotation even if not needed'
        required: false
        default: false
        type: boolean

jobs:
  rotate-jwt-keys:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check if rotation is needed
        id: check-rotation
        run: |
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "needs_rotation=true" >> $GITHUB_OUTPUT
            echo "Forced rotation requested"
          else
            # Check if current keys are older than 85 days (5 days before 90-day target)
            if [ -f "certificates/jwt/rotation-metadata.json" ]; then
              last_rotation=$(jq -r '.lastRotation' certificates/jwt/rotation-metadata.json)
              if [ "$last_rotation" != "null" ]; then
                # Calculate days since last rotation
                days_since=$(( ($(date +%s) - $(date -d "$last_rotation" +%s)) / 86400 ))
                echo "Days since last rotation: $days_since"
                
                if [ $days_since -gt 85 ]; then
                  echo "needs_rotation=true" >> $GITHUB_OUTPUT
                  echo "Rotation needed - $days_since days since last rotation"
                else
                  echo "needs_rotation=false" >> $GITHUB_OUTPUT
                  echo "Rotation not needed - only $days_since days since last rotation"
                fi
              else
                echo "needs_rotation=true" >> $GITHUB_OUTPUT
                echo "No valid last rotation date found"
              fi
            else
              echo "needs_rotation=true" >> $GITHUB_OUTPUT
              echo "No rotation metadata found - first rotation"
            fi
          fi
        
      - name: Rotate JWT Keys
        if: steps.check-rotation.outputs.needs_rotation == 'true'
        run: |
          # Create backup suffix with current date
          backup_suffix=$(date +%Y-%m-%d)-automated
          
          # Run key rotation
          npm run rotate-jwt-keys -- --force --backup-suffix=$backup_suffix
          
          # Verify new keys were generated
          if [ ! -f "certificates/jwt/marketplace-private-key.pem" ]; then
            echo "Error: Private key not found after rotation"
            exit 1
          fi
          
          if [ ! -f "certificates/jwt/marketplace-public-key.pem" ]; then
            echo "Error: Public key not found after rotation"
            exit 1
          fi
          
          echo "Key rotation completed successfully"
      
      - name: Update Vercel Environment Variables
        if: steps.check-rotation.outputs.needs_rotation == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          echo "ğŸ”„ Updating JWT keys in Vercel environment variables..."
          node scripts/update-vercel-env.js
          
          if [ $? -eq 0 ]; then
            echo "âœ… Vercel environment variables updated successfully"
          else
            echo "âŒ Failed to update Vercel environment variables"
            echo "âš ï¸  Manual update required - see PR description for details"
            # Don't fail the workflow - PR will still be created
          fi
      
      - name: Trigger Vercel Deployment
        if: steps.check-rotation.outputs.needs_rotation == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          echo "ğŸš€ Triggering Vercel production deployment..."
          
          # Build deployment payload
          TEAM_PARAM=""
          if [ ! -z "$VERCEL_TEAM_ID" ]; then
            TEAM_PARAM="?teamId=$VERCEL_TEAM_ID"
          fi
          
          # Trigger deployment via Vercel API
          DEPLOY_RESPONSE=$(curl -s -X POST \
            "https://api.vercel.com/v13/deployments${TEAM_PARAM}" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"${VERCEL_PROJECT_ID}\",
              \"gitSource\": {
                \"type\": \"github\",
                \"ref\": \"main\",
                \"repoId\": \"${{ github.repository_id }}\"
              },
              \"target\": \"production\"
            }")
          
          # Extract deployment URL
          DEPLOY_URL=$(echo $DEPLOY_RESPONSE | jq -r '.url // empty')
          
          if [ ! -z "$DEPLOY_URL" ]; then
            echo "âœ… Deployment triggered successfully"
            echo "ğŸŒ Deployment URL: https://$DEPLOY_URL"
            echo "deployment_url=https://$DEPLOY_URL" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Deployment trigger may have failed"
            echo "ğŸ“‹ Response: $DEPLOY_RESPONSE"
            echo "ğŸ’¡ You may need to manually deploy from Vercel dashboard"
          fi
        
      - name: Create Pull Request
        if: steps.check-rotation.outputs.needs_rotation == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ”„ Automated JWT key rotation - $(date +%Y-%m-%d)"
          title: "ğŸ”„ Automated JWT Key Rotation - $(date +%Y-%m-%d)"
          body: |
            ## ğŸ”„ Automated JWT Key Rotation
            
            This PR contains an automated JWT key rotation performed on $(date +%Y-%m-%d).
            
            ### âœ… Changes Applied:
            - ğŸ”‘ New RSA key pair generated and validated
            - ğŸ’¾ Previous keys backed up to `certificates/jwt/backups/`
            - ğŸ“Š Rotation metadata updated
            - ğŸš€ **Vercel environment variables updated automatically**
            - ğŸŒ **Production deployment triggered**
            
            ### ğŸ¯ Vercel Integration:
            The following environment variables have been automatically updated in Vercel:
            - `JWT_PRIVATE_KEY` - New private key for JWT signing
            - `JWT_PUBLIC_KEY` - New public key for JWT verification
            
            A production deployment has been triggered to apply the new keys.
            
            ### âš ï¸ Post-Merge Checklist:
            1. âœ… Review this PR for any issues
            2. âœ… Merge to main branch
            3. ğŸ§ª Verify deployment completed successfully in Vercel dashboard
            4. ğŸ” Test authentication flow:
               - SSO login via eduGAIN/RedIRIS
               - JWT token generation
               - Lab access with new tokens
            5. ğŸ“Š Monitor logs for JWT validation:
               - Marketplace logs (Vercel)
               - Auth-service logs (up to 1 hour for public key cache refresh)
            6. ğŸŒ Verify public key endpoint: `curl https://your-domain/.well-known/public-key.pem`
            
            ### ğŸ“ Files Changed:
            - `certificates/jwt/marketplace-private-key.pem` (new private key)
            - `certificates/jwt/marketplace-public-key.pem` (new public key)  
            - `certificates/jwt/rotation-metadata.json` (updated metadata)
            - `certificates/jwt/backups/` (backup files)
            
            ### ğŸ”§ Troubleshooting:
            If authentication issues occur after deployment:
            1. Check Vercel environment variables are correctly set
            2. Verify deployment completed without errors
            3. Wait up to 1 hour for auth-service public key cache to refresh
            4. If needed, manually trigger auth-service key refresh
            5. Check logs for JWT signature validation errors
            
            **ğŸš¨ Emergency Rollback**: If critical issues occur, restore previous keys from backups using:
            ```bash
            npm run show-keys-for-vercel
            # Copy backup keys to Vercel environment variables manually
            ```
          branch: automated/jwt-key-rotation-$(date +%Y-%m-%d)
          delete-branch: true
          
      - name: Notify team (optional)
        if: steps.check-rotation.outputs.needs_rotation == 'true'
        run: |
          echo "JWT key rotation completed and PR created"
          echo "Next steps: Review PR, merge, and monitor deployment"
          # You could add Slack/Teams notification here